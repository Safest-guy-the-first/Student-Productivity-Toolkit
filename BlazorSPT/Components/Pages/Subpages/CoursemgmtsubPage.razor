@using SPT_API.Models
@inject BlazorSPT.Services.CourseService courseService
@using BlazorSPT.Services;

<div class="course-wrapper">
    <div class="course-header">
        <div class="controls">
            <input type="text"
            class="form-control search-input"
            placeholder="Search courses..."
            @bind="searchTerm"
            @oninput="FilterCourses" />

            <button class="btn btn-primary ms-3" onclick=@(()=> {showAddForm = true;})>Add Course</button>
        </div>
    </div>



    @if (showAddForm == true)
    {
        <AddCourseSubPage addedCourse="addedCourse" User="User" OnCourseAdded="AddCourse" OnCancel="HandleCancel"/>
    } 


    <div class="table-scroll">
        @if (courses == null)
        {
            <p><em>Loading...</em></p>
        }
        @if(courses != null)
        {
            if (courses.Count == 0)
            {
                <p><em>No Courses Found</em></p>
            }
            else
            {
                <table class="table table-striped course-table">
                    <thead>
                        <tr>
                            <th>Course Code</th>
                            <th>Course Title</th>
                            <th>Course Unit</th>
                            <th>Grade</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var course in courses.OrderBy(c => c.CourseTitle))
                        {
                            <tr>
                                <td>@course.CourseCode</td>
                                <td>@course.CourseTitle</td>
                                <td>@course.CourseUnit</td>
                                <td>@course.Grade</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-2" @onclick="() => EditCourse(course)">Edit</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteCourse(course)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }

    </div>
</div>



@code {
    private List<CourseModel>? courses;
    private CourseModel addedCourse = new();



    private bool addSuccess = false;

    [Inject] private AuthService AuthService { get; set; } = default;

    private bool showAddForm = false;

    private string searchTerm = "";

    private StudentModel User;

    private int cunit;

    private string grade;






    private void EditCourse(object m)
    {

    }
    private void DeleteCourse(object m)
    {

    }




    private async void AddCourse()
    {
        courseService.AddCourse(addedCourse);
        showAddForm = false;
        ReloadCourses();
        StateHasChanged();
    }

    public void HandleCancel()
    {
        showAddForm = false;

        StateHasChanged();
    }
    protected override async Task OnInitializedAsync()
    {
        try
        {
            User = AuthService.CurrentUser;
            courseService.currentUser = User;
            courses = await courseService.GetCourses();
        } catch(Exception e)
        {
            Console.WriteLine($"Error fetching courses: {e.Message}");
            courses = new List<CourseModel>();
        }

    }
    protected async Task ReloadCourses()
    {
        courses = await courseService.GetCourses();
        StateHasChanged();
    }
    private async Task FilterCourses(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        courses = await courseService.SearchCourses(searchTerm);
    }

}
